{"version":3,"file":"service-worker.js","sources":["../src/background/service-worker.js"],"sourcesContent":["// PromptCanvas - Background Service Worker\r\n// Handles message passing between content scripts and popup\r\n\r\nconst STORAGE_KEY = 'promptcanvas_templates';\r\n\r\n// ===== Storage Functions =====\r\nasync function getAllTemplates() {\r\n  const result = await chrome.storage.local.get(STORAGE_KEY);\r\n  return result[STORAGE_KEY] || [];\r\n}\r\n\r\nasync function getTemplateByTrigger(trigger) {\r\n  const templates = await getAllTemplates();\r\n  return templates.find(t => t.trigger === trigger);\r\n}\r\n\r\nasync function saveTemplate(template) {\r\n  const templates = await getAllTemplates();\r\n  const now = Date.now();\r\n\r\n  const newTemplate = {\r\n    id: template.id || generateId(),\r\n    name: template.name,\r\n    trigger: template.trigger,\r\n    template: template.template,\r\n    createdAt: template.createdAt || now,\r\n    updatedAt: now\r\n  };\r\n\r\n  const existingIndex = templates.findIndex(t => t.id === newTemplate.id);\r\n  if (existingIndex >= 0) {\r\n    templates[existingIndex] = newTemplate;\r\n  } else {\r\n    templates.push(newTemplate);\r\n  }\r\n\r\n  await chrome.storage.local.set({ [STORAGE_KEY]: templates });\r\n\r\n  // Notify content scripts of updated triggers\r\n  notifyTriggersUpdated();\r\n\r\n  return newTemplate;\r\n}\r\n\r\nasync function deleteTemplate(id) {\r\n  const templates = await getAllTemplates();\r\n  const filtered = templates.filter(t => t.id !== id);\r\n  await chrome.storage.local.set({ [STORAGE_KEY]: filtered });\r\n\r\n  // Notify content scripts of updated triggers\r\n  notifyTriggersUpdated();\r\n}\r\n\r\nfunction generateId() {\r\n  return 'tmpl_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);\r\n}\r\n\r\nasync function notifyTriggersUpdated() {\r\n  const templates = await getAllTemplates();\r\n  const triggers = templates.map(t => t.trigger);\r\n\r\n  // Send to all tabs\r\n  const tabs = await chrome.tabs.query({});\r\n  for (const tab of tabs) {\r\n    try {\r\n      await chrome.tabs.sendMessage(tab.id, { type: 'TRIGGERS_UPDATED', triggers });\r\n    } catch (e) {\r\n      // Tab might not have content script loaded\r\n    }\r\n  }\r\n}\r\n\r\n// ===== Message Handling =====\r\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\r\n  handleMessage(message, sender).then(sendResponse);\r\n  return true; // Keep the message channel open for async response\r\n});\r\n\r\nasync function handleMessage(message, sender) {\r\n  switch (message.type) {\r\n    case 'GET_ALL_TEMPLATES':\r\n      return await getAllTemplates();\r\n\r\n    case 'GET_TEMPLATE_BY_TRIGGER':\r\n      return await getTemplateByTrigger(message.trigger);\r\n\r\n    case 'SAVE_TEMPLATE':\r\n      return await saveTemplate(message.template);\r\n\r\n    case 'DELETE_TEMPLATE':\r\n      await deleteTemplate(message.id);\r\n      return { success: true };\r\n\r\n    case 'GET_ALL_TRIGGERS':\r\n      const templates = await getAllTemplates();\r\n      return templates.map(t => t.trigger);\r\n\r\n    default:\r\n      console.warn('Unknown message type:', message.type);\r\n      return { error: 'Unknown message type' };\r\n  }\r\n}\r\n\r\n// ===== Install Event =====\r\nchrome.runtime.onInstalled.addListener(async (details) => {\r\n  if (details.reason === 'install') {\r\n    // Add default templates\r\n\r\n    // Scene template (/s) - 장면\r\n    const sceneTemplate = {\r\n      name: '장면',\r\n      trigger: '/s',\r\n      template: {\r\n        \"$schemas\": {\r\n          \"characterItem\": {\r\n            \"appearance\": \"$input\",\r\n            \"expression\": \"$input\",\r\n            \"action\": \"$input\",\r\n            \"placement\": \"$select:center|left side|right side|foreground|background\"\r\n          }\r\n        },\r\n        \"_meta\": {\r\n          \"name\": \"장면\",\r\n          \"outputFormat\": \"json\",\r\n          \"trigger\": \"/s\"\r\n        },\r\n        \"background\": \"$input\",\r\n        \"character\": \"$array:characterItem\",\r\n        \"composition\": {\r\n          \"angle\": \"$select:eye-level|low-angle|high-angle|cinematic side view\",\r\n          \"framing\": \"$select:medium shot|wide shot|close-up\"\r\n        },\r\n        \"time_of_day\": \"$select:dawn|day|dusk|night\",\r\n        \"lighting\": \"$select:soft natural light|golden hour|dramatic shadows|flat lighting\",\r\n        \"object\": \"$array:objectItem\",\r\n        \"quality\": {\r\n          \"rendering\": \"high-detail illustration\",\r\n          \"resolution\": \"4K\"\r\n        },\r\n        \"style\": {\r\n          \"art_style\": \"Korean watercolor illustration, ink wash painting\",\r\n          \"mood\": \"$select:warm and whimsical folk tale|dark and dramatic|peaceful and serene\",\r\n          \"texture\": \"rough hanji paper texture\"\r\n        }\r\n      }\r\n    };\r\n\r\n    // Reference sheet template (/r) - 레퍼런스 삼면도\r\n    const referenceTemplate = {\r\n      name: '레퍼런스 삼면도',\r\n      trigger: '/r',\r\n      template: {\r\n        \"_meta\": {\r\n          \"name\": \"레퍼런스 삼면도\",\r\n          \"outputFormat\": \"json\",\r\n          \"trigger\": \"/r\"\r\n        },\r\n        \"subject\": \"$input\",\r\n        \"background\": \"plain white background\",\r\n        \"composition\": {\r\n          \"type\": \"character reference sheet, three-view orthographic\",\r\n          \"views\": \"front view, side view, back view\",\r\n          \"framing\": \"full shot, full body visible\",\r\n          \"layout\": \"three views arranged horizontally\"\r\n        },\r\n        \"quality\": {\r\n          \"rendering\": \"high-detail illustration\",\r\n          \"resolution\": \"4K\"\r\n        },\r\n        \"style\": {\r\n          \"art_style\": \"Korean watercolor illustration, ink wash painting\",\r\n          \"mood\": \"$select:warm and whimsical folk tale|dark and dramatic|peaceful and serene\",\r\n          \"texture\": \"rough hanji paper texture\"\r\n        },\r\n        \"constraints\": {\r\n          \"text\": \"no text, no labels, no annotations\",\r\n          \"consistency\": \"consistent design across all three views\"\r\n        }\r\n      }\r\n    };\r\n\r\n    await saveTemplate(sceneTemplate);\r\n    await saveTemplate(referenceTemplate);\r\n    console.log('PromptCanvas: Default templates installed');\r\n  }\r\n});\r\n"],"names":[],"mappings":"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"}